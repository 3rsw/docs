<!DOCTYPE html>
<!-- Page last generated 2020-01-08 13:21:10 +1100 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Porting seL4 to a new platform | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css"><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117737473-2"></script>
<script>
  if((window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window['ga-disable-UA-117737473-2'] = true;
  }
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117737473-2');
</script>
</head>

  <body class="container-fluid">

    

<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="/">
              <img class="img-responsive" src="/logos/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/Documentation">Documentation</a></h2>
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <h2><a href="https://research.csiro.au/tsblog">Blog</a></h2>
        <iframe title="DuckDuckGo search bar" src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search%20sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;border-width: 0px"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  <div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
              <meta property="position" content="1" />
            </a>
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">Porting seL4 to a new platform</span>
            <meta property="position" content="2" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_10.1.1"><b>seL4-10.1.1</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_10.1.1-mcs"><b>seL4-10.1.1-mcs</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/camkes_release/Camkes_3.7.0"><b>camkes-3.7.0</b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      <div class="row">
  <div class="hidden-xs col-sm-4 col-md-3 col-lg-2">
    <div class="sidebar">

    <h3>seL4</h3>
      <ul class="nav nav-sidebar">
  
        <li class="">
          <a class="" href="/GettingStarted.html">
            Getting Started
          </a>
        </li>
  
        <li class="">
          <a class="" href="/Developing/Building/">
            CMake Build System
          </a>
        </li>
  
        <li class="">
          <a class="" href="/FrequentlyAskedQuestions.html">
            FAQ
          </a>
        </li>
  
        <li class="">
          <a class="" href="/Hardware/">
            Hardware
          </a>
        </li>
  
        <li class="">
          <a class="" href="/CAmkES/">
            CAmkES
          </a>
        </li>
  
        <li class="">
          <a class="" href="/sel4_release/">
            Release Notes
          </a>
        </li>
  
        <li class="">
          <a class="" href="/ApiDoc.html">
            libsel4 API
          </a>
        </li>
  
        <li class="">
          <a class="" href="https://sel4.systems/Info/Docs/seL4-manual-latest.pdf">
            Current Manual
          </a>
        </li>
  
        <li class="">
          <a class="" href="/VerifiedConfigurations.html">
            Verified Configurations
          </a>
        </li>
  
      </ul>

    <h3>Community</h3>
      <ul class="nav nav-sidebar">
  
        <li class="">
          <a class="" href="/Conduct.html">
            Code of Conduct
          </a>
        </li>
  
        <li class="">
          <a class="" href="/Contributing.html">
            Contributing
          </a>
        </li>
  
        <li class="">
          <a class="" href="https://research.csiro.au/tsblog">
            Trustworthy Systems Blog
          </a>
        </li>
  
        <li class="">
          <a class="" href="/IRCChannel.html">
            IRC Channel
          </a>
        </li>
  
        <li class="">
          <a class="" href="/SuggestedProjects.html">
            Suggested projects
          </a>
        </li>
  
        <li class="">
          <a class="" href="/CommunityProjects.html">
            Community Projects
          </a>
        </li>
  
      </ul>


  <h3><a href="/Tutorials">Tutorials</a></h3>
    <ul class="nav nav-sidebar">
  
  
        <li class="">
            <a class="" href="/Tutorials/hello-world.html">Hello, World!</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-0.html">Camkes</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-1.html">Camkes 1</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-2.html">Camkes 2</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/hello-camkes-timer.html">Camkes 3</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-1.html">Dynamic Libraries 1</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-2.html">Dynamic Libraries 2</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-3.html">Dynamic Libraries 3</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/dynamic-4.html">Dynamic Libraries 4</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/mcs.html">MCS</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/capabilities.html">Capabilities</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/untyped.html">Untyped</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/mapping.html">Mapping</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/threads.html">Threads</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/ipc.html">IPC</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/notifications.html">Notifications</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/interrupts.html">Interrupts</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/fault-handlers.html">Faults</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/camkes-vm-linux.html">Camkes VM Linux</a>
        <li>
  
        <li class="">
            <a class="" href="/Tutorials/camkes-vm-crossvm.html">Camkes Cross-VM communication</a>
        <li>
  
    </ul>
</div>


  </div>
  <div class="col-sm-8 col-md-9 col-lg-8 main">
    
    <div class="content">
      <h1 id="porting-sel4-to-a-new-platform">Porting seL4 to a new platform</h1>

<h2 id="setup">Setup</h2>

<p>In order to load the seL4 image (via some means) it is important to have a working bootloader.
We tend to use <a href="https://www.denx.de/wiki/U-Boot">U-boot</a> as it is open source, reliable and supports many different architectures.</p>

<p>For initial setup you can follow the instructions on the UNSW advanced operating systems website regarding <a href="https://www.cse.unsw.edu.au/~cs9242/19/project/linux.shtml">setting up a tftp server</a>.</p>

<p>Once you get U-boot up and running it is a good idea (if the platform is supported) to flash a
Linux image onto the dev board. This way you can find the correct address to load the image into memory.
This is also useful for debugging, as you can use the FDT file system to dump addresses from a running system.</p>

<p>Once you have found the correct address to load, you can use the command <code class="highlighter-rouge">bootcmd="tftpboot 0x20000000 sel4_image &amp;&amp; go 0x20000000"</code> 
(using 0x20000000 as an example) followed by <code class="highlighter-rouge">saveenv</code> to save the starting address onto the boards flash memory.
You will also need to set the ‘ipaddr’ and ‘serverip’ details can be found in the link above.</p>

<h2 id="sel4">seL4</h2>

<p>In order to have a successful port of seL4 to your target ARM platform you will need to go through the following steps.</p>

<h3 id="dts">DTS</h3>

<p>Look for DTS and drivers inside the <a href="https://github.com/torvalds/linux">Linux repository</a>, normally they will be supported. If they are supported clone Linux and modify the <code class="highlighter-rouge">update-dts.sh</code> to add your target. Run the script located in <code class="highlighter-rouge">kernel/tools/dts/update-dts.sh</code> at the cloned Linux repository. This will create a “platform.dts” file from Linux inside the dts folder in the kernel. You may need to add device nodes depending on what Linux uses and what is required by seL4. For example, in the port of the Rockpro64 a memory node and an extra timer node were needed so these had to be defined manually.</p>

<h3 id="hardware-generation-script">Hardware generation script</h3>

<p>Depending on your platform and the way the DTS is defined you may need to modify the hardware_gen.py script.
From the above example the Rockpro64 needed a memory node so that this script could define working memory.
Other gotchas could include interrupt cells, interrupt numbers being mapped wrongly, or incorrect addresses.
Also serial and timer drivers will need to be added to the kernel if they don’t already exist. You can check this through
the DTS device strings and compare to the hardware.yml file in <code class="highlighter-rouge">kernel/tools/hardware.yml</code>. If needed add the required drivers in <code class="highlighter-rouge">kernel/drivers/</code>.</p>

<h3 id="kernel">Kernel</h3>

<p>You will need to add <code class="highlighter-rouge">libsel4/sel4_plat_include/&lt;platform&gt;/sel4/plat/api/constants.h</code> and add sel4_UserTop depending on what you support. Look in the other platform files for examples similar to your platform.</p>

<h3 id="cmake-build-system">CMake-build system</h3>

<p>You will need to modify the build system in two places. Firstly in the kernel’s platform folder, you define <code class="highlighter-rouge">kernel/src/plat/&lt;platform&gt;/config.cmake</code>, again you can look at other platforms for examples.
Secondly, you will need to add ‘KernelPlatform’ to the cmake and elf-loader tools. You can do this by editing 
<code class="highlighter-rouge">tools/cmake-tool/helpers/application_settings.cmake</code> and <code class="highlighter-rouge">tools/elfloader-tool/CMakeLists.txt</code>.</p>

<h3 id="elf-loader">ELF-loader</h3>

<p>You will need to add directories and files <code class="highlighter-rouge">tools/elfloader-tool/src/plat/&lt;platform&gt;/sys_fputc.c</code> and 
<code class="highlighter-rouge">tools/elfloader-tool/include/plat/&lt;platform&gt;/platform.h</code> which will provide a simple implementation of putchar with a physical address for uart for the elf loader to use.</p>

<h2 id="sel4-test">seL4 test</h2>

<p>seL4test needs user level serial and timer drivers to run. Add these drivers and the following files to libplatsupport in
order to get the test suite running. The directory structure and files will look something like the following. Some of these 
files may not have anything in them but include them anyway to keep the build system happy.</p>

<p>Use the other platforms as examples; generally you will have to configure the timer driver by reading the manual, it may have it’s 
own unique programming sequence and can sometimes be a bit tricky.</p>

<p>You can find the physical addresses and interrupt numbers for each device in its platform reference manual and copy them into the right places.</p>

<p><code class="highlighter-rouge">libplatsupport/plat_include/&lt;platform&gt;/</code>
	-<code class="highlighter-rouge">clock.h</code>
	-<code class="highlighter-rouge">gpio.h</code>
	-<code class="highlighter-rouge">i2c.h</code>
	-<code class="highlighter-rouge">mux.h</code>
	-<code class="highlighter-rouge">serial.h</code>
	-<code class="highlighter-rouge">timer.h</code>
<code class="highlighter-rouge">libplatsupport/src/plat/&lt;platform&gt;/</code>
	-<code class="highlighter-rouge">chardev.c</code>
	-<code class="highlighter-rouge">ltimer.c</code>
	-<code class="highlighter-rouge">serial.c</code>
	-<code class="highlighter-rouge">timer.c</code></p>

<h3 id="gotchas">Gotchas</h3>

<p>Incorrect address alignment and incorrect memory regions can cause instruction faults. One way to debug this, is 
to shorten memory regions in DTS memory nodes to check you are touching the correct area.</p>

<p>Once you have succeeded with your port and have seL4 test passing in release mode, you can add an entry to the CHANGES file describing the platform you added and submit a pull request on the seL4 github.</p>

    </div>
  </div>
</div>

    </main>
    

<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      

<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Wed Jan 8 13:20:00 2020 +1100 b1c559a
          </li>
          <li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                Page last updated: Thu Jul 18 18:11:17 2019 +1000 db79522
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
      <a href="https://github.com/SEL4PROJ/docs/blob/master/PortingSeL4.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/SEL4PROJ/docs/edit/master/PortingSeL4.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>
  </body>
</html>
