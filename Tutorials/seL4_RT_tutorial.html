<!DOCTYPE html>
<!-- Page last generated 2018-05-11 04:55:18 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>seL4 5.2.0-MCS Tutorial | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css"><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-117737473-2"></script>
<script>
  if((window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window['ga-disable-UA-117737473-2'] = true;
  }
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-117737473-2');
</script>
</head>

  <body class="container">

    

<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="/">
              <img class="img-responsive" src="/logos/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/Documentation">Documentation</a></h2>
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <h2><a href="https://research.csiro.au/tsblog">Blog&nbsp;<i class="fas fa-external-link-alt icon-resize"></i></a></h2>
        <iframe title="DuckDuckGo search bar" src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search%20sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;border-width: 0px"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  <div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
              <meta property="position" content="1" />
            </a>
        </li>
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/Tutorials/">
              <span property="name"><b>seL4 and CAmkES tutorials</b></span>
              <meta property="position" content="2" />
            </a>
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">seL4 5.2.0-MCS Tutorial</span>
            <meta property="position" content="3" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_9.0.1"><b>seL4-9.0.1</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_9.0.0-mcs"><b>seL4-9.0.0-mcs</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/camkes_release/CAmkES_3.4.0"><b>camkes-3.4.0</b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      
  <nav aria-label="Table of Contents">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#learning-outcomes">Learning outcomes</a></li>
<li class="toc-entry toc-h2"><a href="#walkthrough">Walkthrough</a>
<ul>
<li class="toc-entry toc-h3"><a href="#task-1">TASK 1</a></li>
<li class="toc-entry toc-h3"><a href="#task-2">TASK 2</a></li>
<li class="toc-entry toc-h3"><a href="#task-3">TASK 3</a></li>
<li class="toc-entry toc-h3"><a href="#task-4">TASK 4</a></li>
<li class="toc-entry toc-h3"><a href="#task-5">TASK 5</a></li>
<li class="toc-entry toc-h3"><a href="#task-6">TASK 6</a></li>
<li class="toc-entry toc-h3"><a href="#task-7">TASK 7</a></li>
<li class="toc-entry toc-h3"><a href="#task-8">TASK 8</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#finished">Finished!</a></li>
</ul>
  </nav>


<div class="content">
  <h1 id="sel4-520-mcs-tutorial">seL4 5.2.0-MCS Tutorial</h1>

<p>This tutorial demonstrates how to use the real-time features of the MCS
kernel API, it covers enough such that if you have already done the seL4
tutorials for master and are familiar with the API, you do not need to
redo the previous ones. As a result is does duplicate some of the work
from the other tutorials, but not all.</p>

<p>You’ll observe that the things you’ve already covered in the other
tutorials are already filled out and you don’t have to repeat them: in
much the same way, we won’t be repeating conceptual explanations on this
page, if they were covered by a previous tutorial in the series.</p>

<h2 id="learning-outcomes">Learning outcomes</h2>

<ul>
  <li>Obtain scheduling control capabilities.</li>
  <li>Create and configure scheduling contexts.</li>
  <li>Spawn round-robin and periodic threads.</li>
  <li>Set up a passive server.</li>
  <li>Set up clients to call the passive server using the immediate
    priority ceiling protocol.</li>
</ul>

<h2 id="walkthrough">Walkthrough</h2>

<p>This tutorial is currently stored separately from the other tutorials.
To get the code:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir sel4-mcs-tutorials
cd sel4-mcs-tutorials repo
init -u &lt;https://github.com/SEL4PROJ/sel4-tutorials-manifest&gt; -m sel4-mcs-tutorials.xml
repo sync
</code></pre></div></div>

<p>Then, build and run the tutorial:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># select the config for the first tutorial
make ia32_hello-mcs_defconfig
# build it
make -j8
# run it in qemu
make simulate
</code></pre></div></div>

<p>Before you have done any tasks, when running the tutorial should produce
the following before halting:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mcs &lt;main@main.c&gt;:179 [Cond failed: sched_control == seL4_CapNull]
    Failed to find sched_control.
</code></pre></div></div>

<p>Look for <code class="highlighter-rouge">TASK</code> in the <code class="highlighter-rouge">apps/hello-mcs</code> directory for each task.</p>

<h3 id="task-1">TASK 1</h3>
<p>Find the scheduling control capability. There is one per
node in the system. This allows you to populate scheduling contexts with
parameters.</p>

<p>The output will now look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== Round robin ===
Ping 0
Ping 1
Ping 2
Ping 3
Ping 4
=== Just Ping ===
Ping
Ping
Ping
Ping
Ping
=== Periodic ===
Tick
Tick
Tick
Tick
Tick
Tick
Tick
Tick
Tick
Tick
== Sporadic ==
</code></pre></div></div>

<h3 id="task-2">TASK 2</h3>
<p>Create a scheduling context. The simplest way is to use
the VKA interface. TODO add size.</p>

<p>The output will not change, as we have not given the scheduling context
any time to use. When they are created, scheduling contexts are
‘‘empty’’ and represent no CPU time.</p>

<p>Scheduling contexts are variable sized in order to allow custom maximum
sizes for the refill list. This is discussed in more detail in TASK 7.
The minimum size for a scheduling context is <code class="highlighter-rouge">seL4_MinSchedContextBits</code>.</p>

<h3 id="task-3">TASK 3</h3>

<p>Configure the scheduling context as a round robin thread using the
sched_control capability obtained in TASK 2 and the scheduling context
created in TASK 1.</p>

<p>Once you have reached this point, the tutorial output should change. You
should now see the <code class="highlighter-rouge">yielding_thread</code> that we created outputting messages
in between our own messages, as both threads yield to each other.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== Round robin ===
Ping 0
Pong 0
Ping 1
Pong 1
Ping 2
Pong 2
Ping 3
Pong 3
Ping 4
Pong 4
=== Just Ping ===
Ping
Pong 5
Ping
Pong 6
Ping
Pong 7
Ping
Pong 8
Ping
Pong 9
=== Periodic ===
Pong 10
Pong 11
Pong 12
Pong 13
Pong 14
Pong 15
mcs &lt;yielding_thread@main.c&gt;:87 [Cond failed: i &gt; NUM_YIELDS * 3]
    Too many yeilds!
</code></pre></div></div>

<h3 id="task-4">TASK 4</h3>

<p>Note that in the previous output, while the Round robin section worked,
the ‘‘Just Ping’’ section did not. The <code class="highlighter-rouge">yielding_thread</code> is set to call
abort if it runs for too long.</p>

<p>To fix this, convert the round robin thread to passive by unbinding the
scheduling context. Passive threads do not have their own time. This
will stop the round robin thread from running and the output will be as
follows:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== Round robin ===
Ping 0
Pong 0
Ping 1
Pong 1
Ping 2
Pong 2
Ping 3
Pong 3
Ping 4
Pong 4
=== Just Ping ===
Ping
Ping
Ping
Ping
Ping
=== Periodic ===
Tick
Tick
Tick
Tick
Tick
Tick
Tick
Tick
Tick
Tick
== Sporadic ==
</code></pre></div></div>

<h3 id="task-5">TASK 5</h3>

<p>Reconfigure the scheduling context to be periodic. The output should not
change as the scheduling context is still unbound.</p>

<h3 id="task-6">TASK 6</h3>

<p>Rebind the scheduling context to the thread. Altering scheduling context
state has no impact on the state of the TCB, so it will start where it
left off. No you should see the periodic thread waking every 2 seconds
and printing:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== Round robin ===
Ping 0
Pong 0
Ping 1
Pong 1
Ping 2
Pong 2
Ping 3
Pong 3
Ping 4
Pong 4
=== Just Ping ===
Ping
Ping
Ping
Ping
Ping
=== Periodic ===
Pong 5
Tick
Tick
Pong 6
Tick
Tick
Pong 7
Tick
Tick
Pong 8
Tick
Tick
Pong 9
Tick
Tick
Pong 10
== Sporadic ==
42
0
49
1
56
2
63
3
70
4
76
5
83
6
90
7
97
8
104
Waiting for server
echo:
&lt;&lt;seL4(CPU 0) [decodeInvocation/578 T0xe0295500 "helper_thread" @8049746]: Attempted to invoke a null cap #0.&gt;&gt;
&lt;&lt;seL4(CPU 0) [lookupReply/318 T0xe0295500 "helper_thread" @8049746]: Cap in reply slot is not a reply&gt;&gt;
Caught cap fault in send phase at address 0x0
while trying to handle:
cap fault in receive phase at address 0x0
in thread 0xe0295500 "helper_thread" at address 0x8049746
With stack:
0x10075f2c: 0x10075f5c
0x10075f30: 0x806ef46
0x10075f34: 0x10075f5c
0x10075f38: 0x0
0x10075f3c: 0x0
0x10075f40: 0x0
0x10075f44: 0x0
0x10075f48: 0x0
0x10075f4c: 0x0
0x10075f50: 0x0
0x10075f54: 0x0
0x10075f58: 0x0
0x10075f5c: 0x0
0x10075f60: 0x0
0x10075f64: 0x0
0x10075f68: 0x0
</code></pre></div></div>

<h3 id="task-7">TASK 7</h3>

<p>Now we reconfigure the scheduling context to change the extra_refills
parameter. Extra_refills controls how many times the scheduling context
can change for a non-round robin thread without using up all of its
budget. The current scheduling context is changed when a thread is
preempted, blocks, or makes an RPC to an active thread (a thread that
has its own scheduling context).</p>

<p>For further detail, please see
<a href="https://www.cs.fsu.edu/~awang/papers/rtas2010.pdf">this paper</a>
which explains in detail the sporadic server algorithm the MCS version
of seL4 uses to implement temporal isolation. Note that in code, we use
the term <code class="highlighter-rouge">refill</code> to talk about sporadic replenishments for brevity.</p>

<p>The <code class="highlighter-rouge">sender_thread</code> used in this task simply sends a message and prints
out the number of times it has sent one. The main thread keeps sending
messages, and prints out the current time (in seconds – although on
qemu these values are not reliable so may not match your output). This
causes the current scheduling context to change every time we switch
threads.</p>

<p>Once this task is completed, you should see the sporadic thread print 3
times (1 for the default refill, 2 for the extra refills) before
depleting its budget (by running out of space for refills) until the
next period. Prior to this change, there should be a gap between each
number printed by the task, and the timestamp should change. Now there
should only be a noticeable wait after every 3 numbers, and no gaps in
the timestamps for each set of three numbers.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== Round robin ===
Ping 0
Pong 0
Ping 1
Pong 1
Ping 2
Pong 2
Ping 3
Pong 3
Ping 4
Pong 4
=== Just Ping ===
Ping
Ping
Ping
Ping
Ping
=== Periodic ===
Pong 5
Tick
Tick
Pong 6
Tick
Tick
Pong 7
Tick
Tick
Pong 8
Tick
Tick
Pong 9
Tick
Tick
Pong 10
== Sporadic ==
42
0
42
1
42
2
49
3
49
4
49
5
56
6
56
7
56
8
63
Waiting for server
echo:
&lt;&lt;seL4(CPU 0) [decodeInvocation/578 T0xe0295500 "helper_thread" @80497a6]: Attempted to invoke a null cap #0.&gt;&gt;
&lt;&lt;seL4(CPU 0) [lookupReply/318 T0xe0295500 "helper_thread" @80497a6]: Cap in reply slot is not a reply&gt;&gt;
Caught cap fault in send phase at address 0x0
while trying to handle:
cap fault in receive phase at address 0x0
in thread 0xe0295500 "helper_thread" at address 0x80497a6
With stack:
0x10075f2c: 0x10075f5c
0x10075f30: 0x806efa6
0x10075f34: 0x10075f5c
0x10075f38: 0x0
0x10075f3c: 0x0
0x10075f40: 0x0
0x10075f44: 0x0
0x10075f48: 0x0
0x10075f4c: 0x0
0x10075f50: 0x0
0x10075f54: 0x0
0x10075f58: 0x0
0x10075f5c: 0x0
0x10075f60: 0x0
0x10075f64: 0x0
0x10075f68: 0x0
</code></pre></div></div>

<h3 id="task-8">TASK 8</h3>

<p>You’ll notice an exception in the output of the last run. This is
because we restart our helper thread as an echo server, and pass it an
endpoint and a capability to a reply object. However, since this task is
to create a reply cap the echo server faults instead.</p>

<p>Reply objects are used to track scheduling contexts across call and
reply wait. For users of other versions of seL4, they also simplify the
kernel API, in that the single-use reply capability is generated in the
reply object, which means there is no longer any requirement to make a
specific call to save the reply capability.</p>

<p>This task is to create a reply object, which will stop the echo server
from faulting.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== Round robin ===
Ping 0
Pong 0
Ping 1
Pong 1
Ping 2
Pong 2
Ping 3
Pong 3
Ping 4
Pong 4
=== Just Ping ===
Ping
Ping
Ping
Ping
Ping
=== Periodic ===
Pong 5
Tick
Tick
Pong 6
Tick
Tick
Pong 7
Tick
Tick
Pong 8
Tick
Tick
Pong 9
Tick
Tick
Pong 10
== Sporadic ==
42
0
42
1
42
2
49
3
49
4
49
5
56
6
56
7
56
8
63
Waiting for server
echo:
</code></pre></div></div>
<p>=== TASK 9 ===</p>

<p>The echo server no longer crashes, instead it runs a very inefficient
way IPC echo server as an example passive server for this tutorial.
Currently the main thread waits for a signal from the server that it is
initialised and ready to be converted to passive.</p>

<p>This task is to edit the server (<code class="highlighter-rouge">echo_server</code>) function to signal to the
main thread that it is ready to be converted to passive. Once the main
thread gets this message, it deletes the servers scheduling context and
makes a call to the server. Passive threads do not have their own
scheduling context and run on the scheduling context of the caller - but
only if they are blocked on and IPC endpoint.</p>

<p>The main thread calls the server 3 times with different messages, so you
should see the passive server output 3 messages:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== Round robin ===
Ping 0
Pong 0
Ping 1
Pong 1
Ping 2
Pong 2
Ping 3
Pong 3
Ping 4
Pong 4
=== Just Ping ===
Ping
Ping
Ping
Ping
Ping
=== Periodic ===
Pong 5
Tick
Tick
Pong 6
Tick
Tick
Pong 7
Tick
Tick
Pong 8
Tick
Tick
Pong 9
Tick
Tick
Pong 10
== Sporadic ==
42
0
42
1
42
2
49
3
49
4
49
5
56
6
56
7
56
8
63
Waiting for server
echo:
echo: 2nd message processed
echo: mcs tutorial finished!
</code></pre></div></div>

<h2 id="finished">Finished!</h2>

<p>You’re done. Please enjoy experimenting with the pre-release MCS version
of seL4. Recall that this version is currently undergoing verification,
but is not yet verified - meaning it can crash. If it does please let us
know by raising an issue on the
<a href="https://github.com/seL4/seL4/issues">seL4 Github</a>.</p>

<p>We welcome your feedback and comments, hit us up on the developers
mailing list: <a href="https://sel4.systems/lists/listinfo/devel">https://sel4.systems/lists/listinfo/devel</a>.</p>

</div>

    </main>
    

<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      

<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Fri May 11 14:37:10 2018 +1000 e79ad68
          </li>
          <li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                Page last updated: Tue Mar 13 13:59:55 2018 +1100 5e52647
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
      <a href="https://github.com/SEL4PROJ/docs/blob/master/Tutorials/seL4_RT_tutorial.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/SEL4PROJ/docs/edit/master/Tutorials/seL4_RT_tutorial.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>
  </body>
</html>
