<!DOCTYPE html>
<!-- Page last generated 2018-04-13 05:27:11 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>seL4 Tutorial 2 | seL4 docs</title>

    <!-- Our stylesheet and theme stylesheet.  Contains bootstrap. -->
    <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
    <!-- Font awesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <!-- Pygments syntax highlighting  -->
    <link rel="stylesheet" href="/assets/css/highlighting/trac.css" type="text/css">

  </head>

  <body class="container">

    

<header>
  <ul class="row menu">
    <li class="col-xs-12 col-md-2" >
            <a href="/">
              <img class="img-responsive" src="/logos/logo-text-white.svg" alt="seL4 logo" />
            </a>
    </li>
    <li class="col-xs-12 col-md-10 menu">
      <nav aria-label="Banner links">
        <h2><a href="/Documentation">Documentation</a></h2>
        <h2><a href="/GettingStarted">Getting Started</a></h2>
        <h2><a href="/Tutorials">Tutorials</a></h2>
        <h2><a href="https://research.csiro.au/tsblog">Blog</a></h2>
        <iframe src="https://duckduckgo.com/search.html?site=docs.sel4.systems&prefill=Search sel4.systems" style="overflow:hidden;margin-bottom:10px; padding:0;height:40px;float:right;" frameborder="0"></iframe>
      </nav>
    </li>
  </ul>
  <div class="clear"></div>
  <div class="breadcrumbs bootstrap hidden-sm-down">
  <nav class="sel-breadcrumb" aria-label="Breadcrumb" >
    <ol class=" list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">
      
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/">
              <span property="name"><b>seL4 Docs</b></span>
              <meta property="position" content="1" />
            </a>
        </li>
      
        

        

        <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <a property="item" typeof="WebPage" href="/Tutorials/">
              <span property="name"><b>seL4 and CAmkES tutorials</b></span>
              <meta property="position" content="2" />
            </a>
        </li>
      
        

        
          <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">
            <span property="name">seL4 Tutorial 2</span>
            <meta property="position" content="3" /></li>
          
    </ol>
  </nav>
  <nav class="sel-version" aria-label="Current Versions">
    <ol class="list-unstyled">
      <li class="list-unstyled text-right" style="margin-left:auto; padding:0rem 0rem;">
        Current versions:</li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_9.0.0"><b>seL4-9.0.0</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/sel4_release/seL4_9.0.0-mcs"><b>seL4-9.0.0-mcs</b></a></li>
      <li class="list-unstyled text-right">
      <a href="/camkes_release/CAmkES_3.3.0"><b>camkes-3.3.0</b></a></li>
    </ol>
  </nav>
  <div class='clear'></div>
</div>


</header>

    <main>
      
  <nav aria-label="Table of Contents">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#sel4-tutorial-2">seL4 Tutorial 2</a>
<ul>
<li class="toc-entry toc-h2"><a href="#learning-outcomes">Learning outcomes:</a></li>
<li class="toc-entry toc-h2"><a href="#walkthrough">Walkthrough</a>
<ul>
<li class="toc-entry toc-h3"><a href="#task-1">TASK 1</a></li>
<li class="toc-entry toc-h3"><a href="#task-2">TASK 2</a></li>
<li class="toc-entry toc-h3"><a href="#task-3">TASK 3</a></li>
<li class="toc-entry toc-h3"><a href="#task-4">TASK 4</a></li>
<li class="toc-entry toc-h3"><a href="#task-5">TASK 5</a></li>
<li class="toc-entry toc-h3"><a href="#task-6">TASK 6</a></li>
<li class="toc-entry toc-h3"><a href="#task-7">TASK 7</a></li>
<li class="toc-entry toc-h3"><a href="#task-8">TASK 8</a></li>
<li class="toc-entry toc-h3"><a href="#task-9">TASK 9</a></li>
<li class="toc-entry toc-h3"><a href="#task-10">TASK 10</a></li>
<li class="toc-entry toc-h3"><a href="#task-11">TASK 11</a></li>
<li class="toc-entry toc-h3"><a href="#task-12">TASK 12</a></li>
<li class="toc-entry toc-h3"><a href="#task-13">TASK 13</a></li>
<li class="toc-entry toc-h3"><a href="#task-14">TASK 14</a></li>
<li class="toc-entry toc-h3"><a href="#task-15">TASK 15</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#globals-links">Globals links</a></li>
</ul>
</li>
</ul>
  </nav>


<div class="content">
  <h1 id="sel4-tutorial-2">seL4 Tutorial 2</h1>
<p>The second tutorial is useful in that
it addresses conceptual problems for two different types of developers:</p>

<ul>
  <li>Experienced kernel developers whose minds are pre-programmed to
    think in terms of “One address space equals one process”, and
    begins to introduce the seL4 CSpace vs VSpace model.</li>
  <li>New kernel developers, for whom the tutorial will prompt them on
    what to read about.</li>
</ul>

<p>Don’t gloss over the globals declared before <code class="highlighter-rouge">main()</code> – they’re declared
for your benefit so you can grasp some of the basic data structures.
Uncomment them one by one as needed when going through the tasks.</p>

<h2 id="learning-outcomes">Learning outcomes:</h2>

<ul>
  <li>Understand the kernel’s startup procedure.</li>
  <li>Understand that the kernel centers around certain objects and
      capabilities to those objects.</li>
  <li>Understand that libraries exist to automate the very
      fine-grained nature of the seL4 API, and get a rough idea of
      some of those libraries.</li>
  <li>Learn how the kernel hands over control to userspace.</li>
  <li>Get a feel for how the seL4 API enables developers to manipulate
      the objects referred to by the capabilities they encounter.</li>
  <li>Understand the how to spawn new threads in seL4, and the basic
      idea that a thread has a TCB, VSpace and CSpace, and that you
      must fill these out.</li>
</ul>

<h2 id="walkthrough">Walkthrough</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># select the config for the first tutorial
make ia32_hello-2_defconfig
# build it
make -j8
# run it in qemu
make simulate
</code></pre></div></div>

<p>Look for <code class="highlighter-rouge">TASK</code> in the <code class="highlighter-rouge">apps/hello-2</code> directory for each task.</p>

<h3 id="task-1">TASK 1</h3>

<p>After bootstrap, the kernel hands over control to to an init thread.
This thread receives a structure from the kernel that describes all the
resources available on the machine. This structure is called the
BootInfo structure. It includes information on all IRQs, memory, and
IO-Ports (x86). This structure also tells the init thread where certain
important capability references are. This step is teaching you how to
obtain that structure.</p>

<p>Note that when you run the example, you should get a message similar to:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6 untypeds of size 29
hello-2: &lt;main@main.c&gt;:132 [Cond failed: allocman == NULL]
Failed to initialize alloc manager.
Memory pool sufficiently sized?
Memory pool pointer valid?
</code></pre></div></div>

<p>until Task 4, where you set up memory management.</p>

<p><a href="https://github.com/seL4/seL4/blob/release/libsel4/include/sel4/bootinfo_types.h">https://github.com/seL4/seL4/blob/release/libsel4/include/sel4/bootinfo_types.h</a></p>

<h3 id="task-2">TASK 2</h3>

<p>The “Simple” library is one of those you were introduced to in the
slides: you need to initialize it with some default state before using
it.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4simple-default/include/simple-default/simple-default.h">https://github.com/seL4/seL4_libs/blob/master/libsel4simple-default/include/simple-default/simple-default.h</a></p>

<h3 id="task-3">TASK 3</h3>

<p>Just a simple debugging print-out function. Allows you to examine the
layout of the BootInfo.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h">https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h</a></p>

<h3 id="task-4">TASK 4</h3>

<p>In seL4, memory management is delegated in large part to userspace, and
each process manages its own page faults with a custom pager. Without
the use of the <code class="highlighter-rouge">allocman</code> library and the <code class="highlighter-rouge">VKA</code> library, you would have to
manually allocate a frame, then map the frame into a page-table, before
you could use new memory in your address space. In this tutorial you
don’t go through that procedure, but you’ll encounter it later. For now,
use the allocman and VKA allocation system. The allocman library
requires some initial memory to bootstrap its metadata. Complete this
step.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4allocman/include/allocman/bootstrap.h">https://github.com/seL4/seL4_libs/blob/master/libsel4allocman/include/allocman/bootstrap.h</a></p>

<h3 id="task-5">TASK 5</h3>

<p><code class="highlighter-rouge">libsel4vka</code> is an seL4 type-aware object allocator that will allocate new
kernel objects for you. The term “allocate new kernel objects” in seL4
is a more detailed process of “retyping” previously un-typed memory.
seL4 considers all memory that hasn’t been explicitly earmarked for a
purpose to be “untyped”, and in order to repurpose any memory into a
useful object, you must give it an seL4-specific type. This is retyping,
and the VKA library simplifies this for you, among other things.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4allocman/include/allocman/vka.h">https://github.com/seL4/seL4_libs/blob/master/libsel4allocman/include/allocman/vka.h</a></p>

<h3 id="task-6">TASK 6</h3>

<p>This is where the differences between seL4 and contemporary kernels
begin to start playing out. Every kernel-object that you “retype” will
be handed to you using a capability reference. The seL4 kernel keeps
multiple trees of these capabilities. Each separate tree of capabilities
is called a “CSpace”. Each thread can have its own CSpace, or a CSpace
can be shared among multiple threads. The delineations between
“Processes” aren’t well-defined, since seL4 doesn’t have any real
concept of “processes”. It deals with threads. Sharing and isolation is
based on CSpaces (shared vs not-shared) and VSpaces (shared vs
not-shared). The “process” idea goes as far as perhaps the fact that at
the hardware level, threads sharing the same VSpace are in a traditional
sense, siblings, but logically in seL4, there is no concept of
“Processes” really.</p>

<p>So you’re being made to grab a reference to your thread’s CSpace’s root
“CNode”. A CNode is one of the many blocks of capabilities that make up
a CSpace.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h">https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h</a></p>

<h3 id="task-7">TASK 7</h3>

<p>Just as in the previous step, you were made to grab a reference to the
root of your thread’s CSpace, now you’re being made to grab a reference
to the root of your thread’s VSpace.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h">https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h</a></p>

<h3 id="task-8">TASK 8</h3>

<p>In order to manage the threads that are created in seL4, the seL4 kernel
keeps track of TCB (Thread Control Block) objects. Each of these
represents a schedulable executable resource. Unlike other contemporary
kernels, seL4 <strong>doesn’t</strong> allocate a stack, virtual-address space
(VSpace) and other metadata on your behalf. This step creates a TCB,
which is a very bare-bones, primitive resource, which requires you to
still manually fill it out.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4vka/include/vka/object.h">https://github.com/seL4/seL4_libs/blob/master/libsel4vka/include/vka/object.h</a></p>

<h3 id="task-9">TASK 9</h3>

<p>You must create a new VSpace for your new thread if you need it to
execute in its own isolated address space, and tell the kernel which
VSpace you plan for the new thread to execute in. This opens up the
option for threads to share VSpaces. In similar fashion, you must also
tell the kernel which CSpace your new thread will use – whether it will
share a currently existing one, or whether you’ve created a new one for
it. That’s what you’re doing now.</p>

<p>In this particular example, you’re allowing the new thread to share your
main thread’s CSpace and VSpace.</p>

<p><a href="https://github.com/seL4/seL4/blob/master/libsel4/include/interfaces/sel4.xml">https://github.com/seL4/seL4/blob/master/libsel4/include/interfaces/sel4.xml</a></p>

<h3 id="task-10">TASK 10</h3>

<p>This is a convenience function – sets a name string for the TCB object.</p>

<h3 id="task-11">TASK 11</h3>

<p>Pay attention to the line that precedes this particular task – the line
that zeroes out a new “seL4_UserContext” object. As we previously
explained, seL4 requires you to fill out the Thread Control Block
manually. That includes the new thread’s initial register contents. You
can set the value of the stack pointer, the instruction pointer, and if
you want to get a little creative, you can pass some initial data to
your new thread through its registers.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4utils/sel4_arch_include/x86_64/sel4utils/sel4_arch/util.h">https://github.com/seL4/seL4_libs/blob/master/libsel4utils/sel4_arch_include/x86_64/sel4utils/sel4_arch/util.h</a></p>

<h3 id="task-12">TASK 12</h3>

<p>This TASK is just some pointer arithmetic. The cautionary note that the
stack grows down is meant to make you think about the arithmetic.
Processor stacks push new values toward decreasing addresses, so give it
some thought.</p>

<p><a href="https://github.com/seL4/seL4_libs/blob/master/libsel4utils/sel4_arch_include/x86_64/sel4utils/sel4_arch/util.h">https://github.com/seL4/seL4_libs/blob/master/libsel4utils/sel4_arch_include/x86_64/sel4utils/sel4_arch/util.h</a></p>

<h3 id="task-13">TASK 13</h3>

<p>As explained above, we’ve been filling out our new thread’s TCB for the
last few operations, so now we’re writing the values we’ve chosen, to
the TCB object in the kernel.</p>

<p><a href="https://github.com/seL4/seL4/blob/master/libsel4/include/interfaces/sel4.xml">https://github.com/seL4/seL4/blob/master/libsel4/include/interfaces/sel4.xml</a></p>

<h3 id="task-14">TASK 14</h3>

<p>Finally, we tell the kernel that our new thread is runnable. From here,
the kernel itself will choose when to run the thread based on the
priority we gave it, and according to the kernel’s configured scheduling
policy.</p>

<p><a href="https://github.com/seL4/seL4/blob/3.0.0/libsel4/include/interfaces/sel4.xml">https://github.com/seL4/seL4/blob/3.0.0/libsel4/include/interfaces/sel4.xml</a></p>

<h3 id="task-15">TASK 15</h3>

<p>For the sake of confirmation that our new thread was executed by the
kernel successfully, we cause it to print something to the screen.</p>

<h2 id="globals-links">Globals links</h2>

<ul>
  <li><code class="highlighter-rouge">sel4_BootInfo</code>:
    <a href="https://github.com/seL4/seL4/blob/release/libsel4/include/sel4/bootinfo_types.h">https://github.com/seL4/seL4/blob/release/libsel4/include/sel4/bootinfo_types.h</a></li>
  <li><code class="highlighter-rouge">simple_t</code>:
    <a href="https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h">https://github.com/seL4/seL4_libs/blob/master/libsel4simple/include/simple/simple.h</a></li>
  <li><code class="highlighter-rouge">vka_t</code>:
    <a href="https://github.com/seL4/seL4_libs/blob/master//libsel4vka/include/vka/vka.h">https://github.com/seL4/seL4_libs/blob/master//libsel4vka/include/vka/vka.h</a></li>
  <li><code class="highlighter-rouge">allocman_t</code>:
    <a href="https://github.com/seL4/seL4_libs/blob/master/libsel4allocman/include/allocman/allocman.h">https://github.com/seL4/seL4_libs/blob/master/libsel4allocman/include/allocman/allocman.h</a></li>
  <li><code class="highlighter-rouge">name_thread()</code>:
    <a href="https://github.com/SEL4PROJ/sel4-tutorials/blob/master/exercises/hello-2/src/util.c">https://github.com/SEL4PROJ/sel4-tutorials/blob/master/exercises/hello-2/src/util.c</a></li>
</ul>


</div>

    </main>
    

<footer class="site-footer">

  <h2 class="footer-heading">seL4 docs</h2>

  <div class="footer-col-wrapper">

    <div class="col-md-2">
      

<ul class="social-media-list">
  <li><a href="https://github.com/sel4"><i class="fab fa-github"></i> <span class="username">sel4</span></a></li><li><a href="https://github.com/sel4proj"><i class="fab fa-github"></i> <span class="username">sel4proj</span></a></li>
</ul>

    </div>

    <div class="col-md-8">
      <ul class="list-unstyled">
        <li>
          This site is for displaying seL4 related documentation.  Pull requests are welcome.
        </li>
        
          <li>
            Site last updated: Fri Apr 13 15:21:46 2018 +1000 e8cbde7
          </li>
          <li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                Page last updated: Tue Mar 13 13:59:55 2018 +1100 cbc9080
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          </li>
        
      </ul>
    </div>
    <div class="col-md-2">
      <a href="https://github.com/SEL4PROJ/docs/blob/master/Tutorials/seL4_Tutorial_2.md">View page on GitHub</a>
      <br />
      <a href="https://github.com/SEL4PROJ/docs/edit/master/Tutorials/seL4_Tutorial_2.md">Edit page on GitHub</a>
      <br />
      <a href="/sitemap">Sitemap</a>
    </div>

  </div>

</footer>
  </body>
</html>
